# Gemini API 성능 최적화 방안

본 문서는 서비스의 Gemini API 응답 성능을 개선하기 위한 구체적인 실행 방안과 우선순위를 정의합니다.

---

### **Priority 1: API 호출 분석 및 로깅 강화 (Foundation)**

**목표**: 모든 API 호출 데이터를 수집하여 병목 지점을 정확히 식별하고, 데이터 기반의 의사결정 토대를 마련합니다.

**필요성**: 정확한 측정 없이는 개선도 없습니다. 현재 시스템의 성능을 객관적으로 파악하는 것이 모든 최적화의 첫걸음입니다.

**실행 방안**:

1.  **`OrchestratorService` 내 API 호출 로깅 구현**:

    - **내용**: NestJS 데코레이터 또는 미들웨어를 활용하여 Gemini API를 호출하는 공통 지점에서 로그를 기록합니다.
    - **수집 데이터**:
      - 호출 에이전트 (e.g., `AnalysisAgent`, `NewsAgent`)
      - 요청 시 사용된 모델 파라미터 (`temperature`, `topP` 등)
      - 요청 ~ 응답(첫 토큰)까지의 End-to-End 소요 시간
      - 응답 생성에 사용된 토큰 수
      - 오류 발생 여부 및 내용

2.  **기본 성능 대시보드 또는 분석 스크립트 마련**:
    - **내용**: 수집된 로그를 바탕으로 에이전트별 평균 응답 시간, 시간대별 성능 변화 등을 확인할 수 있는 간단한 시각화 도구나 분석 스크립트를 작성합니다.
    - **기대효과**: 성능 저하가 발생하는 특정 에이전트나 패턴을 신속하게 파악할 수 있습니다.

---

### **Priority 2: 스트리밍 체감 성능 최적화 (User Experience)**

**목표**: 백엔드에서 프론트엔드로 이어지는 데이터 파이프라인을 최적화하여 사용자가 느끼는 응답 대기 시간을 최소화합니다.

**필요성**: API의 실제 처리 시간과 별개로, 사용자는 화면에 텍스트가 얼마나 빨리 나타나는지로 성능을 체감합니다. 스트리밍 최적화는 가장 확실한 체감 성능 개선 방안입니다.

**실행 방안**:

1.  **백엔드 스트림 로직 점검**:

    - **위치**: `apps/backend/src/chat/orchestrator.service.ts`
    - **내용**: Gemini API로부터 받은 데이터 청크(chunk)를 어떠한 버퍼링이나 가공 대기 없이 즉시 클라이언트로 전송(`response.write()`)하는지 확인합니다. 불필요한 `await`으로 인해 스트림이 지연되지 않는지 코드 레벨에서 검토합니다.
    - **권장사항**: Server-Sent Events (SSE) 방식을 사용하여 스트림을 안정적으로 전달합니다.

2.  **프론트엔드 렌더링 최적화**:
    - **위치**: `apps/frontend/src/app/components/Chat.tsx`
    - **내용**: 스트림 데이터를 받을 때마다 전체 채팅 UI를 다시 그리는 대신, 마지막 메시지 컴포넌트의 내용만 점진적으로 업데이트하도록 로직을 수정합니다.
    - **구현**: React의 함수형 `setState` (`setMessages(prev => ...)`)를 사용하여 불필요한 리렌더링을 방지하고 성능을 확보합니다.

---

### **Priority 3: 모델 파라미터 튜닝 (Fine-Tuning)**

**목표**: `Priority 1`에서 수집한 데이터를 바탕으로, 각 에이전트의 역할에 맞는 최적의 파라미터를 찾아 응답 속도와 품질의 균형을 맞춥니다.

**필요성**: 불필요하게 긴 응답을 제한하고, 에이전트 특성에 맞는 파라미터를 적용하여 비용과 속도를 모두 개선할 수 있습니다.

**실행 방안**:

1.  **에이전트별 파라미터 설정 분리**:

    - **내용**: 모든 에이전트가 동일한 설정을 공유하는 대신, 각 에이전트의 특성에 맞게 `temperature`, `maxOutputTokens` 등을 개별적으로 관리할 수 있도록 설정 파일을 분리합니다.

2.  **`maxOutputTokens` 최적화**:

    - **내용**: 로깅된 데이터를 분석하여 각 에이전트가 평균적으로 반환하는 답변 길이를 파악하고, 불필요하게 설정된 `maxOutputTokens` 값을 합리적인 수준으로 조정합니다.
    - **기대효과**: 응답 생성 시간을 직접적으로 단축하고 비용을 절감합니다.

3.  **`temperature`, `topP` 등 품질 파라미터 A/B 테스트**:
    - **내용**: 속도 개선이 이루어진 후, 답변의 창의성이 중요한 에이전트와 사실 기반 답변이 중요한 에이전트를 구분하여 각기 다른 `temperature` 값을 적용하고, 내부적으로 결과물의 품질을 비교 평가하여 최적점을 찾습니다.
